<!DOCTYPE html>
<html>
<head>
    <title>上传文件</title>
    <style></style>
</head>

<body>

<div id="progress_bar">
    <div class="percent">0%</div>

    <label for="files">文件：</label><input type="file" id="files" name="files" multiple/>


    <script type="text/javascript" src="../js/lib/spark-md5.js" charset="utf-8"></script>

    <script>

        function readFileDone(file, md5) {
            console.log("fileName=%s, fileSize=%d, md5=%s, stamp=%d", file.name, file.size, md5, new Date().getTime());
        }

        var CHUNK_SIZE = 2 * 1024 * 1024; //2M Bytes
        //上传文件的进度条
        var progress = document.querySelector('.percent');
        function updateProgress(evt) {
            //evt is an ProgressEvent
            if (evt.lengthComputable) {
                var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
                //Increase the progress bar length.
                if (percentLoaded < 100) {
                    progress.style.width = percentLoaded + '%';
                    progress.textContent = percentLoaded + '%';
                }
            }
        }
        //注意此方法引用了SparkMD5库 library:https://github.com/satazor/SparkMD5
        //监听文本框变化
        document.getElementById("files").addEventListener("change", function () {  //声明必要的变量

            var files = document.getElementById("files").files;
            for (var i = 0; i< files.length; i++) {
                var file = files[i];
                console.log('i=%d, fileName=%s, fileSize=%d', i, file.name, file.size);

                var fileReader = new FileReader();
                if (file.size < CHUNK_SIZE) {
                    fileReader.readAsBinaryString(file);
                    fileReader.onload = function(e){
                        readFileDone(file, SparkMD5.hashBinary(e.target.result));
                    }
                } else {
//                onProgress(fileReader);
                    //文件分割方法（注意兼容性）
                    var blobSlice = File.prototype.mozSlice || File.prototype.webkitSlice || File.prototype.slice,
                            file,
                        //文件每块分割2M，计算分割详情
                            chunks = Math.ceil(file.size / CHUNK_SIZE),
                            currentChunk = 0,
                        //创建md5对象（基于SparkMD5）
                            spark = new SparkMD5();
                    //每块文件读取完毕之后的处理
                    fileReader.onload = function (e) {

                        console.log("读取第", currentChunk + 1, "块，共", chunks + "块");
                        //每块交由sparkMD5进行计算
                        spark.appendBinary(e.target.result);
                        currentChunk++;
                        //如果文件处理完成计算MD5，如果还有分片继续处理
                        if (currentChunk < chunks) {
                            loadNext();
                        } else {
                            var md5 = spark.end();
                            console.log("分块文件读取完毕");

                            readFileDone(file, md5);
                       }
                    };

                    //处理单片文件的上传
                    function loadNext() {
                        var start = currentChunk * CHUNK_SIZE, end = start + CHUNK_SIZE >= file.size ? file.size : start + CHUNK_SIZE;
                        fileReader.readAsBinaryString(blobSlice.call(file, start, end));
                    }

                    loadNext();
                }
            }
        });
    </script>


</body>
</html>
