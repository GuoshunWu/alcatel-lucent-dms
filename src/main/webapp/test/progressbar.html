<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Load...</title>

    <link href="../css/jqueryUI/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css"/>
    <style type='text/css'>
        html, body {
            font-family: 'Verdana', '宋体', serif;
            font-size: 10px;
            height: 99%;
        }


    </style>

    <script src="../js/lib/jquery-1.7.2.min.js"></script>
    <script src="../js/lib/jquery-ui-1.8.22.custom.min.js"></script>

    <script>
        jQuery(function ($) {
            var url = '../scripts/cp.groovy';

            $("#progressbar").draggable({
                grid: [50, 20],
                opacity: 0.35
            }).progressbar({
                        max: 100,
                        create: function (e, ui) {
                            $('#barvalue', this).position({my: 'center', at: 'center', of: this});
                        },
                        change: function (e, ui) {
                            var value;
                            value = ($(this).progressbar("value")).toPrecision(4) + '%';
                            return $('#barvalue', this).html(value).position({my: 'center', at: 'center', of: this});
                        },
                        complete: function (e, ui) {
                            $(this).hide().progressbar('value', 0);
                            $('#startAction').button('enable').button('option', 'label', 'Start');
                        }

                    }).hide();

            function progress(msg, sep) {
                if (!sep) {
                    sep = ';';
                }
                $(msg.split(sep)).each(function (index, elem) {
                    if ($.isNumeric(elem)) {
                        $('#progressbar').progressbar("value", parseFloat(elem));
                    }
                });
            }

            function long_polling(cmd, evtId) {
                var postData = {cmd: cmd, evtId: evtId};
                if (cmd == 'start') {
                    postData.freq = $('#eFreq').val() ? parseInt($('#eFreq').val()) : 2000;
                    postData.speed = $("#speed").val() ? parseInt($("#speed").val()) : 1000;
                }

                if (postData.freq < 2)postData.freq = 2
                if (postData.speed < 2)postData.freq = 2

                $.getJSON(url, postData).done(function (data, textStatus, jqXHR) {
                    if (console) {
                        console.log(data);
                    }
                    progress(data.msg);
                    if (/done/.test(data.msg)) return;
                    setTimeout(function () {
                        long_polling('process', data.evtId)
                    }, $("#pollingFreq").val() ? parseInt($("#pollingFreq").val()) : 1000);
                });
            }

            $('#startAction').button().click(function (e) {
                $("#progressbar").show();
                $('#barvalue').position({my: 'center', at: 'center', of: '#progressbar'});
                long_polling('start', -1);
                $(this).button('disable').button('option', 'label', 'In progress...');
            });

        });
    </script>
</head>
<body>
<h2 align="center">Progress bar demo...</h2>
<table border="0" align="center">
    <tr>
        <td>
            <b>Total number: 10000</b>
        </td>
        <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
        <td>
            Event generator frequency(ms): <input size="5" id="eFreq" value="2000"/>
        </td>
        <td>
            Process speed: <input size="5" id="speed" value="1000"/>
        </td>
        <td>
            Polling frequency(ms): <input size="5" id="pollingFreq" value="1000"/>
        </td>
        <td>
            <button id="startAction">Start</button>
        </td>
    </tr>
</table>

<div id="logs" style="font-family: monospace;"/>

<div id="progressbar" style="position: absolute;width: 600px; top: 45%;left: 30%; ">
    <span id="barvalue" style="z-index: 1000;display:block;text-align:center;position: absolute;"/>
</div>

</body>
</html>