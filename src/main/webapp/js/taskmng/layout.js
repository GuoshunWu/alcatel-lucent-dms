// Generated by CoffeeScript 1.3.3
(function() {

  define(['jqlayout', 'taskmng/task_grid', 'require', 'i18n!nls/common', 'taskmng/dialogs'], function($, grid, require, c18n, dialogs) {
    var productInfo, taskFileUpload;
    $('#pageNavigator').val(window.location.pathname);
    $("#optional-container").layout({
      resizable: true,
      closable: true
    });
    productInfo = {};
    if (window.location.search) {
      $(window.location.search.split('?')[1].split('&')).each(function(index, elem) {
        var kv;
        kv = elem.split('=');
        return productInfo[kv[0]] = kv[1];
      });
    }
    $.getJSON('rest/products', {
      prop: 'id,name'
    }, function(json) {
      $('#productBase').append(new Option(c18n.select.product.tip, -1));
      $('#productBase').append($(json).map(function() {
        var opt;
        opt = new Option(this.name, this.id);
        if (productInfo.productBase && this.id === parseInt(productInfo.productBase)) {
          opt.selected = true;
        }
        return opt;
      }));
      return $('#productBase').trigger('change');
    });
    $('#productBase').change(function() {
      $('#productRelease').empty();
      if (parseInt($('#productBase').val()) === -1) {
        return false;
      }
      return $.getJSON("/rest/products/version", {
        base: $(this).val(),
        prop: 'id,version'
      }, function(json) {
        $('#productRelease').append(new Option(c18n.select.release.tip, -1));
        $('#productRelease').append($(json).map(function() {
          var opt;
          opt = new Option(this.version, this.id);
          if (productInfo.product && this.id === parseInt(productInfo.product)) {
            opt.selected = true;
          }
          return opt;
        }));
        return $('#productRelease').trigger("change");
      });
    });
    $('#productRelease').change(function() {
      var param;
      param = {
        release: {
          id: $(this).val(),
          version: $(this).find("option:selected").text()
        }
      };
      if (!$('#productBase').val() || parseInt($('#productBase').val()) === -1) {
        return false;
      }
      if (!param.release.id || parseInt(param.release.id) === -1) {
        return false;
      }
      return grid.productVersionChanged(param);
    });
    ($("#progressbar").draggable({
      grid: [50, 20],
      opacity: 0.35
    }).css({
      'z-index': 100,
      width: 600,
      textAlign: 'center',
      'position': 'absolute',
      'top': '45%',
      'left': '30%'
    }).progressbar({
      change: function(e, ui) {
        var value;
        value = ($(this).progressbar("value")).toPrecision(4) + '%';
        return $('#barvalue', this).html(value).css({
          "display": "block",
          "textAlign": "center"
        });
      }
    })).hide();
    taskFileUpload = 'taskFileUpload';
    $('#uploadTask').button({
      label: 'Upload'
    }).css({
      overflow: 'hidden'
    }).append($("<input type='file' id='" + taskFileUpload + "' name='upload' title='Choose file' multiple/>").css({
      position: 'absolute',
      top: 0,
      right: 0,
      margin: 0,
      border: '1px transparent',
      borderWidth: '0 0 40px 0px',
      opacity: 0,
      filter: 'alpha(opacity=0)',
      cursor: 'pointer'
    }));
    $('#optional-container').show();
    return $('#loading-container').remove();
  });

}).call(this);
