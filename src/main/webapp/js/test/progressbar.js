// Generated by CoffeeScript 1.5.0
(function() {

  jQuery(function($) {
    var long_polling, progress, url;
    progress = function(msg, sep) {
      if (!sep) {
        sep = ";";
      }
      return $(msg.split(sep)).each(function(index, elem) {
        if ($.isNumeric(elem)) {
          return $("#progressbar").progressbar("value", parseFloat(elem));
        }
      });
    };
    long_polling = function(cmd, evtId) {
      var pollingInterval, postData, reTryAjax, timeout;
      postData = {
        cmd: cmd,
        evtId: evtId
      };
      if (cmd === "start") {
        postData.freq = ($("#eFreq").val() ? parseInt($("#eFreq").val()) : 2000);
        postData.speed = ($("#speed").val() ? parseInt($("#speed").val()) : 1000);
      }
      if (postData.freq < 2) {
        postData.freq = 2;
      }
      if (postData.speed < 2) {
        postData.speed = 2;
      }
      pollingInterval = $("#pollingFreq").val() ? parseInt($("#pollingFreq").val()) : 1000;
      timeout = $("#timeout").val() ? parseInt($("#timeout").val()) : 5000;
      reTryAjax = function(retryTimes, retryCounter) {
        if (retryTimes == null) {
          retryTimes = Number.MAX_VALUE;
        }
        if (retryCounter == null) {
          retryCounter = 0;
        }
        return $.ajax(url, {
          cache: false,
          data: postData,
          timeout: timeout,
          type: 'post',
          dataType: "json"
        }).done(function(data, textStatus, jqXHR) {
          if (typeof console !== "undefined" && console !== null) {
            console.log(data);
          }
          progress(data.msg);
          if (/done/.test(data.msg)) {
            progress("100");
            return;
          }
          return setTimeout((function() {
            return long_polling("process", data.evtId);
          }), pollingInterval);
        }).fail(function(jqXHR, textStatus, errorThrown) {
          if ('timeout' !== textStatus) {
            if (typeof console !== "undefined" && console !== null) {
              console.log("error: " + textStatus);
            }
            return;
          }
          if (retryTimes > 0) {
            if (typeof console !== "undefined" && console !== null) {
              console.log("Request " + textStatus + ", I will retry in " + pollingInterval + " milliseconds.");
            }
            return setTimeout((function() {
              return reTryAjax(--retryTimes, ++retryCounter);
            }), pollingInterval);
          } else {
            return typeof console !== "undefined" && console !== null ? console.log("I have retried " + retryCounter + " times. There may be a network connection issue, please check network cable.") : void 0;
          }
        });
      };
      return reTryAjax(10);
    };
    url = "../scripts/cp.groovy";
    /* Initilize the page elements
    */

    $("#progressbar").draggable({
      grid: [50, 20],
      opacity: 0.35
    }).progressbar({
      max: 100,
      create: function(e, ui) {
        this.label = $('div.progressbar-label', this);
        return $(this).position({
          my: 'center',
          at: 'center',
          of: window
        });
      },
      change: function(e, ui) {
        return this.label.html(($(this).progressbar("value").toPrecision(4)) + "%");
      },
      complete: function(e, ui) {
        $(this).hide();
        return $("#startAction").button("enable").button("option", "label", "Start");
      }
    }).hide();
    return $("#startAction").button().click(function(e) {
      $("#progressbar").progressbar("value", 0).show().position({
        my: 'center',
        at: 'center',
        of: window
      });
      long_polling("start", -1);
      return $(this).button("disable").button("option", "label", "In progress...");
    });
  });

}).call(this);
