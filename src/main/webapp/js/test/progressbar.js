// Generated by CoffeeScript 1.4.0
(function() {

  jQuery(function($) {
    var long_polling, progress, url;
    progress = function(msg, sep) {
      if (!sep) {
        sep = ";";
      }
      return $(msg.split(sep)).each(function(index, elem) {
        if ($.isNumeric(elem)) {
          return $("#progressbar").progressbar("value", parseFloat(elem));
        }
      });
    };
    long_polling = function(cmd, evtId) {
      var postData;
      postData = {
        cmd: cmd,
        evtId: evtId
      };
      if (cmd === "start") {
        postData.freq = ($("#eFreq").val() ? parseInt($("#eFreq").val()) : 2000);
        postData.speed = ($("#speed").val() ? parseInt($("#speed").val()) : 1000);
      }
      if (postData.freq < 2) {
        postData.freq = 2;
      }
      if (postData.speed < 2) {
        postData.speed = 2;
      }
      return $.ajax(url, {
        cache: false,
        data: postData,
        dataType: "json"
      }).done(function(data, textStatus, jqXHR) {
        if (console) {
          console.log(data);
        }
        progress(data.msg);
        if (/done/.test(data.msg)) {
          return;
        }
        return setTimeout((function() {
          return long_polling("process", data.evtId);
        }), ($("#pollingFreq").val() ? parseInt($("#pollingFreq").val()) : 1000));
      });
    };
    url = "../scripts/cp.groovy";
    /* Initilize the page elements
    */

    $("#progressbar").draggable({
      grid: [50, 20],
      opacity: 0.35
    }).progressbar({
      max: 100,
      create: function(e, ui) {
        this.label = $('div.progressbar-label', this);
        return $(this).position({
          my: 'center',
          at: 'center',
          of: window
        });
      },
      change: function(e, ui) {
        return this.label.html(($(this).progressbar("value").toPrecision(4)) + "%");
      },
      complete: function(e, ui) {
        $(this).progressbar("value", 0).hide();
        return $("#startAction").button("enable").button("option", "label", "Start");
      }
    }).hide();
    return $("#startAction").button().click(function(e) {
      $("#progressbar").show();
      long_polling("start", -1);
      return $(this).button("disable").button("option", "label", "In progress...");
    });
  });

}).call(this);
