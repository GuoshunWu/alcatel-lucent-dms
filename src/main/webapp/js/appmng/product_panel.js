// Generated by CoffeeScript 1.6.2
(function() {
  define(['jqmsgbox', 'i18n!nls/common', 'dms-urls', 'dms-util', 'appmng/application_grid', 'appmng/dialogs'], function($, c18n, urls, util, grid, dialogs) {
    var productInfo, searchActionBtn,
      _this = this;

    $("#newVersion").button({
      text: false,
      label: '&nbsp;',
      icons: {
        primary: "ui-icon-plus"
      }
    }).attr('privilegeName', util.urlname2Action('app/create-product-release')).click(function() {
      return $("#newProductReleaseDialog").dialog("open");
    });
    $("#removeVersion").button({
      text: false,
      label: '&nbsp;',
      icons: {
        primary: "ui-icon-minus"
      }
    }).attr('privilegeName', util.urlname2Action('app/remove-product')).click(function() {
      var id;

      id = $("#selVersion").val();
      if (!id) {
        return;
      }
      $.post('app/remove-product', {
        id: id
      }, function(json) {
        if (json.status !== 0) {
          $.msgBox(json.message, null, {
            title: c18n.error
          });
        }
      });
      $("#selVersion option:selected").remove();
      return $('#selVersion').trigger('change');
    });
    searchActionBtn = $('#prodSearchAction', '#appmng').attr('title', 'Search').button({
      text: false,
      icons: {
        primary: "ui-icon-search"
      }
    }).height(20).width(20).position({
      my: 'left center',
      at: 'right center',
      of: '#prodSearchText'
    }).click(function(e) {
      var node, selVer;

      selVer = $("#selVersion", '#DMS_productPanel');
      if (!selVer.val() || -1 === selVer.val()) {
        node = util.getProductTreeInfo();
        $.msgBox(c18n.noversion('Product', node.text));
        return;
      }
      return dialogs.showSearchResult({
        text: $('#prodSearchText', '#appmng').val(),
        version: {
          id: selVer.val(),
          text: $("option:selected", selVer).text()
        },
        fuzzy: Boolean($('#prodSearchText_fuzzy').attr('checked'))
      });
    });
    $('#prodSearchText', '#appmng').keydown(function(e) {
      if (e.which !== 13) {
        return true;
      }
      searchActionBtn.trigger('click');
      return false;
    });
    productInfo = {};
    $('#selVersion').change(function() {
      var product;

      product = {
        version: $(this).find("option:selected").text(),
        id: $(this).val()
      };
      if (!product.id) {
        product.id = -1;
      }
      productInfo.product = product;
      return grid.productChanged(productInfo);
    });
    return {
      refresh: function(info) {
        productInfo.base = {
          id: info.id,
          text: info.text
        };
        $('#dispProductName').html(productInfo.base.text);
        return $.getJSON(urls.prod_versions, {
          base: productInfo.base.id,
          prop: 'id,version'
        }, function(json) {
          var selVer;

          selVer = $('#selVersion', "div[id='appmng']");
          selVer.empty().append(util.json2Options(json));
          if (param.currentSelected.productId && parseInt(param.currentSelected.productId) !== -1) {
            selVer.val(param.currentSelected.productId);
            param.currentSelected.productId = null;
          }
          return selVer.trigger('change');
        });
      },
      getSelectedProduct: function() {
        return {
          version: $("#selVersion option:selected").text(),
          id: $('#selVersion').val()
        };
      },
      getProductSelectOptions: function() {
        return $('#selVersion').children('option').clone(true);
      },
      addNewProduct: function(product) {
        return $('#selVersion').append(util.newOption(product.version, product.id, true)).trigger('change');
      }
    };
  });

}).call(this);
