// Generated by CoffeeScript 1.3.3
(function() {

  define(function(require) {
    var $, URL, c18n, dialogs, grid, localIds, productInfo,
      _this = this;
    $ = require('jquery');
    grid = require('appmng/application_grid');
    dialogs = require('appmng/dialogs');
    require('jqmsgbox');
    c18n = require('i18n!nls/common');
    URL = {
      get_product_by_base_id: '/rest/products/version'
    };
    localIds = {
      select_product_version: '#selVersion',
      new_product_version: '#newVersion',
      remove_product_version: '#removeVersion',
      disp_product_name: '#dispProductName'
    };
    $("" + localIds.new_product_version).button({
      text: false,
      label: '&nbsp;',
      icons: {
        primary: "ui-icon-plus"
      }
    }).click(function() {
      return dialogs.newProductVersion.dialog("open");
    });
    $("" + localIds.remove_product_version).button({
      text: false,
      label: '&nbsp;',
      icons: {
        primary: "ui-icon-minus"
      }
    }).click(function() {
      var id;
      id = $("" + localIds.select_product_version).val();
      if (!id) {
        return;
      }
      return $.post('/app/remove-product', {
        id: id
      }, function(json) {
        if (json.status !== 0) {
          $.msgBox(json.message, null, {
            title: c18n.error
          });
          return;
        }
        return $("" + localIds.select_product_version + " option:selected").remove().trigger('change');
      });
    });
    productInfo = {};
    $(localIds.select_product_version).change(function() {
      var product;
      product = {
        version: $(this).find("option:selected").text(),
        id: $(this).val()
      };
      if (!product.id) {
        product.id = -1;
      }
      productInfo.product = product;
      return grid.productChanged(productInfo);
    });
    return {
      refresh: function(info) {
        productInfo.base = {
          id: info.id,
          text: info.text
        };
        $(localIds.disp_product_name).html(productInfo.base.text);
        return $.getJSON(URL.get_product_by_base_id, {
          base: productInfo.base.id,
          prop: 'id,version'
        }, function(json) {
          $(localIds.select_product_version).empty().append($(json).map(function() {
            return new Option(this.version, this.id);
          }));
          return $(localIds.select_product_version).trigger('change');
        });
      },
      getSelectedProduct: function() {
        return {
          version: $(localIds.select_product_version).find("option:selected").text(),
          id: $(localIds.select_product_version).val()
        };
      },
      getProductSelectOptions: function() {
        return $(localIds.select_product_version).children('option').clone(true);
      },
      addNewProduct: function(product) {
        var newOption;
        newOption = new Option(product.version, product.id);
        newOption.selected = true;
        return $(localIds.select_product_version).append(newOption).trigger('change');
      },
      removeProduct: function(product) {}
    };
  });

}).call(this);
